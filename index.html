<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Card Draw</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="lib/timeago.js"></script>
    <script src="cards.js"></script>
    
    <!-- Dynamically preload card images from cardData -->
    <script>
        // Preload card back
        const backPreload = document.createElement('link');
        backPreload.rel = 'preload';
        backPreload.as = 'image';
        backPreload.href = cardData.back;
        document.head.appendChild(backPreload);
        
        // Preload all card faces
        cardData.cards.forEach(cardPath => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'image';
            link.href = cardPath;
            document.head.appendChild(link);
        });
    </script>
    
    <script defer src="lib/alpine.js"></script>
    <script src="main.js"></script>
</head>
<body>
    <div id="app" class="container" x-data="cardApp()">
        <!-- Mobile tap areas for opening modals -->
        <button 
            class="mobile-tap-area mobile-tap-top" 
            @click="toggleModal()"
            x-show="!showModal && !showHistoryModal"
            x-cloak
            aria-label="Open card browser"
        ></button>
        <button 
            class="mobile-tap-area mobile-tap-bottom" 
            @click="toggleHistoryModal()"
            x-show="!showModal && !showHistoryModal"
            x-cloak
            aria-label="Open history"
        ></button>

        <div class="card-viewport">
            <div 
                class="card-stack"
                :style="{ aspectRatio: cardData.width + '/' + cardData.height }"
                @click="flipCard($event)"
                @touchstart="startDrag($event)"
                @touchmove="onDrag($event)"
                @touchend="endDrag($event)"
                @mousedown="startDrag($event)"
                @mousemove="onDrag($event)"
                @mouseup="endDrag($event)"
                @dragstart.prevent
            >
                <!-- Deck (Base - always visible) -->
                <div class="card card-deck" :style="{ aspectRatio: cardData.width + '/' + cardData.height }">
                    <img :src="cardData.back" :style="{ aspectRatio: cardData.width + '/' + cardData.height }" alt="Card Deck" draggable="false">
                </div>
                
                <!-- Flipping Card with Both Faces -->
                <template x-if="currentCard">
                    <div 
                        class="card-container"
                        :class="{ 'is-flipping': isFlipping, 'is-flipped': isFlipped, 'is-dragging': isDragging }"
                        :style="{ 
                            '--zAngle': zAngle,
                            ...(isDragging ? { transform: `rotateY(180deg) translate(${dragOffsetX}px, ${dragOffsetY}px) rotateZ(calc(var(--zAngle) * 1deg))` } : {})
                        }"
                    >
                        <!-- Front Face (the actual card) -->
                        <div class="card-face card-face-front">
                            <img :src="currentCard"  alt="Card Front" draggable="false">
                        </div>
                        <!-- Back Face (card back design) -->
                        <div class="card-face card-face-back">
                            <img :src="cardData.back" alt="Card Back" draggable="false">
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Card Browser Modal -->
        <div 
            class="modal-overlay" 
            x-show="showModal" 
            x-cloak
            @click.self="closeModal()"
            x-transition:enter="modal-enter"
            x-transition:enter-start="modal-enter-start"
            x-transition:enter-end="modal-enter-end"
            x-transition:leave="modal-leave"
            x-transition:leave-start="modal-leave-start"
            x-transition:leave-end="modal-leave-end"
        >
            <div class="modal-content">
                <div class="modal-grid" :class="{ 'modal-grid-expanded': isListExpanded }">
                    <!-- Left Panel - Card Preview -->
                    <div class="modal-preview">
                        <div class="preview-card-container">
                            <template x-if="selectedPreviewCard">
                                <div 
                                    class="preview-card"
                                    :class="{ 'preview-card-entering': isPreviewAnimating }"
                                >
                                    <img :src="selectedPreviewCard" :style="{ aspectRatio: cardData.width + '/' + cardData.height }" alt="Card Preview">
                                </div>
                            </template>
                            <template x-if="!selectedPreviewCard">
                                <div class="preview-placeholder">
                                    <p>Select a card to preview</p>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Card List -->
                    <div class="modal-list">
                        <div class="modal-header">
                            <div class="modal-header-left">
                                <button class="modal-expand" @click="toggleListExpansion()" aria-label="Toggle list size">
                                    <svg x-show="!isListExpanded" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="18 15 12 9 6 15"></polyline>
                                    </svg>
                                    <svg x-show="isListExpanded" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <h2>All Cards</h2>
                            </div>
                            <button class="modal-close" @click="closeModal()" aria-label="Close">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="card-list-scroll">
                            <template x-for="card in cardData.cards" :key="card">
                                <div 
                                    class="card-list-item"
                                    :class="{ 'active': selectedPreviewCard === card }"
                                    @click="selectCard(card)"
                                >
                                    <div class="card-list-thumb">
                                        <img :src="card" :style="{ aspectRatio: cardData.width + '/' + cardData.height }" alt="Card thumbnail">
                                    </div>
                                    <div class="card-list-info">
                                        <span class="card-list-name" x-text="getCardName(card)"></span>
                                        <span class="card-list-meta" x-text="'played: ' + getPlayCount(card)" x-show="getPlayCount(card) > 0"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div 
            class="modal-overlay" 
            x-show="showHistoryModal" 
            x-cloak
            @click.self="closeHistoryModal()"
            x-transition:enter="modal-enter"
            x-transition:enter-start="modal-enter-start"
            x-transition:enter-end="modal-enter-end"
            x-transition:leave="modal-leave"
            x-transition:leave-start="modal-leave-start"
            x-transition:leave-end="modal-leave-end"
        >
            <div class="modal-content">
                <div class="modal-grid" :class="{ 'modal-grid-expanded': isListExpanded }">
                    <!-- Left Panel - Card Preview -->
                    <div class="modal-preview">
                        <div class="preview-card-container">
                            <template x-if="selectedHistoryCard">
                                <div 
                                    class="preview-card"
                                    :class="{ 'preview-card-entering': isHistoryAnimating }"
                                >
                                    <img :src="selectedHistoryCard" :style="{ aspectRatio: cardData.width + '/' + cardData.height }" alt="Card Preview">
                                </div>
                            </template>
                            <template x-if="!selectedHistoryCard && cardHistory.length > 0">
                                <div class="preview-placeholder">
                                    <p>Select a card to preview</p>
                                </div>
                            </template>
                            <template x-if="cardHistory.length === 0">
                                <div class="preview-placeholder">
                                    <p>No cards in history yet</p>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Right Panel - History List -->
                    <div class="modal-list">
                        <div class="modal-header">
                            <div class="modal-header-left">
                                <button class="modal-expand" @click="toggleListExpansion()" aria-label="Toggle list size">
                                    <svg x-show="!isListExpanded" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="18 15 12 9 6 15"></polyline>
                                    </svg>
                                    <svg x-show="isListExpanded" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <h2>Play History</h2>
                            </div>
                            <div class="modal-header-actions">
                                <button 
                                    class="modal-clear" 
                                    @click="clearHistory()" 
                                    aria-label="Clear History"
                                    x-show="cardHistory.length > 0"
                                >
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                                <button class="modal-close" @click="closeHistoryModal()" aria-label="Close">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="card-list-scroll">
                            <template x-if="cardHistory.length === 0">
                                <div class="empty-history">
                                    <p>No cards drawn yet. Start drawing cards to build your history!</p>
                                </div>
                            </template>
                            <template x-for="(entry, index) in cardHistory.slice().reverse()" :key="index">
                                <div 
                                    class="card-list-item"
                                    :class="{ 'active': selectedHistoryCard === getHistoryCardPath(entry) }"
                                    @click="selectHistoryCard(entry)"
                                >
                                    <div class="card-list-thumb">
                                        <img :src="getHistoryCardPath(entry)" :style="{ aspectRatio: cardData.width + '/' + cardData.height }" alt="Card thumbnail">
                                    </div>
                                    <div class="card-list-info">
                                        <span class="card-list-name" x-text="getCardName(getHistoryCardPath(entry))"></span>
                                        <span class="card-list-meta" x-text="getTimeAgo(entry)" x-show="getTimeAgo(entry)"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
